<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>暑いぞ！館林 ~最高気温で町おこし~</title>
<script src="lib/mrdoob-three.js-1769fbf/build/three.js"></script>
<script src="lib/mrdoob-three.js-1769fbf/examples/js/controls/TrackballControls.js"></script>
<script src="lib/misc/js/Object3DMaker.js"></script>
<script src="font/electronic_highway_sign_regular.typeface.js"></script>
<style>
*{padding:0px; margin:0px}
div#main_frame{
    width: 500px;
    height: 500px;
    overflow:hidden;
}
</style>
<script>
"use strict";
window.addEventListener("load", function() {
    var battleobj = new battle();
    battleobj.drawStart();
});

function battle(){}

battle.prototype ={
    drawStart: function(){
        this.initBattleTime();
        this.initThree();
        this.initObject();
        this.initCamera();
        this.initLight();
        setInterval(this.loop.bind(this), 300);
    },

    initBattleTime: function(){
        //開始時間の取得
        this.startTime = new Date();
        var endTime = new Date();

        //１バトル何分で終了か
        var battleMinuts = 10;
        //現実世界より何分の1で進むか
        this.erapsedSpeed = 86400 / ( 60 * battleMinuts );
        //1バトル(1日)何秒か
        var battleSecond = (( 60 / ( 60 * this.erapsedSpeed ) ) * 60) * 24 * 60;
        //終了時間計算
        var endDate = this.startTime.getSeconds() + battleSecond;
        endTime.setSeconds(endDate);
        console.debug( endTime );
    },

    getBattleTime: function(){
        //現在時刻取得
        var now = new Date();
        //startからの差分で時間経過を取得
        var diff = now.getTime() - this.startTime.getTime();
        now.setTime( new Date('2008/5/1 0:00:00').getTime() + ( diff *  this.erapsedSpeed ) );
//        console.debug( diff, now , now.getHours(), now.getMinutes());

if(this.Text){
    this.scene.remove(this.Text );
    this.TextGeometry.dispose();
    this.Material.dispose();
}

this.TextGeometry = new THREE.TextGeometry( now.getHours() +":"+ now.getMinutes() , {
                size: 10, height: 1,
                font: "electronic highway sign", style: "normal",
                bevelThickness: 1, bevelSize: 1, bevelEnabled: false
});
this.Material = new THREE.MeshLambertMaterial( { color: 0xaaaaaa } );
this.Text = new THREE.Mesh( this.TextGeometry, this.Material );

this.scene.add( this.Text );
this.Text.position.set(-90,80,1);

    },

    initThree: function(){
        //キャンバスフレームDOM要素の取得
        this.canvasFrame = document.getElementById('main_frame');
        //レンダラーオブジェクトの生成
        this.renderer = new THREE.WebGLRenderer({ antialias: true });

        if (!this.renderer) alert('Three.js の初期化に失敗しました');
        //レンダラーのサイズの設定
        this.renderer.setSize(this.canvasFrame.clientWidth, this.canvasFrame.clientHeight);
        //キャンバスフレームDOM要素にcanvas要素を追加
        this.canvasFrame.appendChild(this.renderer.domElement);

        //レンダラークリアーカラーの設定
        this.renderer.setClearColor(0xEEEEEE, 1.0);

        //シーンオブジェクトの生成
        this.scene = new THREE.Scene();
    },

    initCamera: function(){
        //カメラオブジェクトの生成
        this.camera = new THREE.PerspectiveCamera(90, this.canvasFrame.clientWidth / this.canvasFrame.clientHeight, 1, 10000);
        //カメラの位置の設定
        this.camera.position.set(0, 0, 100);
        //カメラの上ベクトルの設定
        this.camera.up.set(0, 10, 0);
        //カメラの中心位置ベクトルの設定
        this.camera.lookAt({ x: 0, y: 0, z: 0 }); //トラックボール利用時は自動的に無効

        //トラックボールオブジェクトの宣言
        this.trackball = new THREE.TrackballControls(this.camera, this.canvasFrame);

        //トラックボール動作範囲のサイズとオフセットの設定
        this.trackball.screen.width = this.canvasFrame.clientWidth;                        //横幅
        this.trackball.screen.height = this.canvasFrame.clientHeight;                      //縦幅
        this.trackball.screen.offsetLeft = this.canvasFrame.getBoundingClientRect().left;  //左オフセット
        this.trackball.screen.offsetTop = this.canvasFrame.getBoundingClientRect().top;    //右オフセット

        //トラックボールの回転無効化と回転速度の設定
        this.trackball.noRotate = false;
        this.trackball.rotateSpeed = 4.0;

        //トラックボールの拡大無効化と拡大速度の設定
        this.trackball.noZoom = false;
        this.trackball.zoomSpeed = 4.0;

        //トラックボールのカメラ中心移動の無効化と中心速度の設定
        this.trackball.noPan = false;
        this.trackball.panSpeed = 1.0;
        this.trackball.target = new THREE.Vector3(0, 0, 0);

        //トラックボールのスタティックムーブの有効化
        this.trackball.staticMoving = true;
        //トラックボールのダイナミックムーブ時の減衰定数
        this.trackball.dynamicDampingFactor = 0.3;
    },

    initObject: function(){
        //軸オブジェクトの生成
        this.axis = new THREE.AxisHelper(100);
        //軸オブジェクトのシーンへの追加
        this.scene.add(this.axis);
        //軸オブジェクトの位置座標を設定
        this.axis.position.set(0, 0, 0);

        //マップのグループを作る
        this.mapgroup = new THREE.Object3D();
        this.scene.add(this.mapgroup);

        this.makeMap();
    },

    initLight: function(){
        //平行光源オブジェクトの生成
        var directionalLight = new THREE.DirectionalLight(0xffffff, 1.0, 0);
        //平行光源オブジェクトの位置の設定
        directionalLight.position.set(0, 0, 1);
        //平行光源オブジェクトのシーンへの追加
        this.scene.add(directionalLight);
    },

    makeMap: function(){
        var object_tree_params = [
            { name: "mapGroup",
                group:[
                    //地図
                    { name:"map", type:"plane", posi:[0, 0, 0],
                      texture:{imgsrc:"images/map2.png", offset:[0, 0, 0]},
                      width:200, height:200
                    },
                    //南北に走る道路
                    { name:"centerStreet", type:"polygon", posi:[-40, -95, 1],
                          edges:[[22,118],
                                 [23,118], [38,0], [37,0]],
                          color: 0x5A5850
                    },
                    //南東の道路
                    { name:"DanchiStreet", type:"polygon", posi:[-40, -95, 1],
                          edges:[[33 , 36],
                                 [140, 36], [140, 35], [33 , 35]],
                          color: 0x5A5850
                    },
                    //東端の道路
                    { name:"DanchiStreet", type:"polygon", posi:[-40, -95, 1],
                          edges:[[-55, 60],
                                 [-56, 60], [-54, 0], [-56, 0]],
                          color: 0x5A5850
                    },
                    //消防署
                    { name:"fireofficeStreet", type:"polygon", posi:[0, 0, 1],
                          edges:[[-70, 0],
                                 [-60, 2], [-49, -70], [-59, -72]],
                          color: 0x999999,
                          amount: 10
                    },
                    //ネッツ道路
                    { name:"netzStreet", type:"plane", posi:[0, 25, 1],
                      texture:{imgsrc:"images/white.png", offset:[0, 0, 0], x:10, y:1, repeat:true},
                      width:200, height:7
                    },
                    //シリンダー
                    { name:"amedas", materialtype:"Phong", type:"cylinder", color:0xffffff,
                    posi:[-35, 0, 1],rotate:[(Math.PI / 180 ) * 90, 0, 0],
                      radiusTop:8, radiusBottom:8, height:10,radiusSegments:100
                    },

                ]   //end group
            }   //end mapGropup
        ];  //end object_tree_params


        var objmaker = new Object3DMaker();
        var object3d = objmaker.make(object_tree_params);
        this.mapgroup.add(object3d);
    },

    loop: function(){
         this.getBattleTime();

        //トラックボールによるカメラオブジェクトのプロパティの更新
        this.trackball.update();
        //レンダリング
        this.renderer.render(this.scene, this.camera);
   },

}

</script>
</head>
<body>
    <div id="main_frame"></div><!-- canvas要素を配置するdiv要素 -->
</body>
</html>